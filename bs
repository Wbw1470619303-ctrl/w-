-- Delta é€‚é… + Fluent UI ç§»æ¤è„šæœ¬
-- åŠ è½½ Fluent UI æ ¸å¿ƒåº“ï¼ˆDelta å…¼å®¹ç‰ˆï¼‰
local success, Fluent = pcall(function()
    return loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
end)
if not success then
    warn("Fluent UI åŠ è½½å¤±è´¥ï¼ŒDelta æ³¨å…¥å™¨éœ€å…è®¸ Http è¯·æ±‚")
    game.Players.LocalPlayer:Kick("Fluent UI åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ³¨å…¥å™¨æƒé™")
    return
end

local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Delta é€‚é…å·¥å…·å‡½æ•°ï¼ˆå…¼å®¹ cloneref/syn ç­‰ APIï¼‰
local function getService(name)
    local service = game:GetService(name)
    if cloneref then return cloneref(service) end
    return service
end

-- æ ¸å¿ƒæœåŠ¡åˆå§‹åŒ–ï¼ˆDelta å®‰å…¨è·å–ï¼‰
local HttpService = getService("HttpService")
local Players = getService("Players")
local CoreGui = getService("CoreGui")
local TweenService = getService("TweenService")
local RunService = getService("RunService")
local ReplicatedStorage = getService("ReplicatedStorage")
local ProximityPromptService = getService("ProximityPromptService")
local Workspace = getService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- å…¨å±€çŠ¶æ€ç®¡ç†ï¼ˆDelta æŒä¹…åŒ–å…¼å®¹ï¼‰
local GlobalState = {
    Features = {KillAura = false, AutoChop = false, AutoEat = false, ChildESP = false, ChestESP = false, InstantInteract = false},
    DoorsInstantInteract = false,
    DoorsAutoSkip = false,
    DoorsMonsterDetectionEnabled = false,
    DoorsSeekDetectionEnabled = false,
    CurrentTheme = "Dark",
    Config = {FileSaving = false, Format = false}
}

-- ==================== å¡å¯†ç³»ç»Ÿç§»æ¤ï¼ˆDelta é€‚é…ï¼‰====================
local RayfieldKeySystem = {}
RayfieldKeySystem.__index = RayfieldKeySystem

function RayfieldKeySystem.new(KeySettings, DisableBuildWarnings)
    local self = setmetatable({}, RayfieldKeySystem)
    self.KeySettings = KeySettings
    self.DisableBuildWarnings = DisableBuildWarnings
    self.Passthrough = false
    self:ValidateKeySettings()
    self:InitFileSystem()
    self:CheckBuildCompatibility()
    return self
end

-- å¡å¯†ç³»ç»Ÿæ ¸å¿ƒæ–¹æ³•ï¼ˆä¿ç•™åŸé€»è¾‘ï¼Œé€‚é… Delta è·¯å¾„ï¼‰
function RayfieldKeySystem:ValidateKeySettings()
    if not self.KeySettings then
        warn("Rayfield | æœªæä¾›å¡å¯†é…ç½®ï¼Œè·³è¿‡éªŒè¯")
        self.Passthrough = true
        return
    end
    self.KeySettings.Title = self.KeySettings.Title or "BSè„šæœ¬"
    self.KeySettings.Subtitle = self.KeySettings.Subtitle or "å¡å¯†éªŒè¯"
    self.KeySettings.Note = self.KeySettings.Note or "QQç¾¤ï¼š467186748 è·å–å¡å¯†"
    self.KeySettings.FileName = self.KeySettings.FileName or "BS_Script_Key"
    self.KeySettings.SaveKey = self.KeySettings.SaveKey ~= nil and self.KeySettings.SaveKey or true
    self.KeySettings.GrabKeyFromSite = self.KeySettings.GrabKeyFromSite ~= nil and self.KeySettings.GrabKeyFromSite or true
    if typeof(self.KeySettings.Key) == "string" then
        self.KeySettings.Key = {self.KeySettings.Key}
    end
    self.KeySettings.Key = self.KeySettings.Key or {}
   Â 
    if self.KeySettings.GrabKeyFromSite then
        for i, KeyUrl in ipairs(self.KeySettings.Key) do
            local Success, Response = pcall(function()
                local RawKey = tostring(game:HttpGet(KeyUrl):gsub("[\n\r]", " "))
                self.KeySettings.Key[i] = string.gsub(RawKey, " ", "")
            end)
            if not Success then
                print("å¡å¯†è·å–å¤±è´¥ï¼š" .. KeyUrl .. " - " .. tostring(Response))
            end
        end
    end
    self.AttemptsRemaining = math.random(2, 5)
end

function RayfieldKeySystem:InitFileSystem()
    if isfolder and not isfolder("Rayfield/Key System") then
        makefolder("Rayfield/Key System")
    end
    if isfile and isfile("Rayfield/Key System/" .. self.KeySettings.FileName .. ".rfld") then
        local SavedKey = readfile("Rayfield/Key System/" .. self.KeySettings.FileName .. ".rfld")
        for _, ValidKey in ipairs(self.KeySettings.Key) do
            if SavedKey == ValidKey then
                self.Passthrough = true
                break
            end
        end
    end
end

function RayfieldKeySystem:CheckBuildCompatibility()
    local InterfaceBuild = '3K3W'
    local correctBuild = false
    local buildAttempts = 0
    local RayfieldUI = game:GetObjects("rbxassetid://10804731440")[1]
    repeat
        if RayfieldUI:FindFirstChild('Build') and RayfieldUI.Build.Value == InterfaceBuild then
            correctBuild = true
            break
        end
        correctBuild = false
        if not self.DisableBuildWarnings then
            warn('Rayfield | ç‰ˆæœ¬ä¸å…¼å®¹ï¼Œå¯èƒ½å½±å“åŠŸèƒ½')
        end
        local toDestroy = RayfieldUI
        RayfieldUI = game:GetObjects("rbxassetid://10804731440")[1]
        if toDestroy then toDestroy:Destroy() end
        buildAttempts = buildAttempts + 1
    until buildAttempts >= 2
    RayfieldUI:Destroy()
end

function RayfieldKeySystem:LoadKeyUI()
    local KeyUI = game:GetObjects("rbxassetid://11380036235")[1]
    KeyUI.Enabled = true
    if gethui then
        KeyUI.Parent = gethui()
    elseif syn and syn.protect_gui then
        syn.protect_gui(KeyUI)
        KeyUI.Parent = CoreGui
    else
        KeyUI.Parent = CoreGui.RobloxGui or CoreGui
    end
    self.KeyUI = KeyUI
    self.KeyMain = KeyUI.Main
    self:InitKeyUIStyle()
    self:BindKeyUIEvents()
end

function RayfieldKeySystem:InitKeyUIStyle()
    local KeyMain = self.KeyMain
    KeyMain.Title.Text = self.KeySettings.Title
    KeyMain.Subtitle.Text = self.KeySettings.Subtitle
    KeyMain.NoteMessage.Text = self.KeySettings.Note
    KeyMain.Size = UDim2.new(0, 467, 0, 175)
    KeyMain.BackgroundTransparency = 1
    -- ç®€åŒ– Tween åŠ¨ç”»ï¼ˆDelta æ€§èƒ½ä¼˜åŒ–ï¼‰
    TweenService:Create(KeyMain, TweenInfo.new(0.6), {BackgroundTransparency = 0, Size = UDim2.new(0, 500, 0, 187)}):Play()
    task.wait(0.1)
    TweenService:Create(KeyMain.Title, TweenInfo.new(0.4), {TextTransparency = 0}):Play()
    TweenService:Create(KeyMain.Subtitle, TweenInfo.new(0.5), {TextTransparency = 0}):Play()
end

function RayfieldKeySystem:BindKeyUIEvents()
    local InputBox = self.KeyMain.Input.InputBox
    InputBox.FocusLost:Connect(function()
        if #InputBox.Text == 0 then return end
        local KeyFound = false
        for _, ValidKey in ipairs(self.KeySettings.Key) do
            if InputBox.Text == ValidKey then
                KeyFound = true
                break
            end
        end
        if KeyFound then
            self:OnKeyValid(InputBox.Text)
        else
            self:OnKeyInvalid()
        end
    end)
    self.KeyMain.Hide.MouseButton1Click:Connect(function()
        self:CloseKeyUI()
    end)
end

function RayfieldKeySystem:OnKeyValid(FoundKey)
    -- éªŒè¯æˆåŠŸåŠ¨ç”»
    TweenService:Create(self.KeyMain, TweenInfo.new(0.6), {BackgroundTransparency = 1}):Play()
    task.wait(0.5)
    self.Passthrough = true
    self.KeyUI:Destroy()
    if self.KeySettings.SaveKey and writefile then
        writefile("Rayfield/Key System/" .. self.KeySettings.FileName .. ".rfld", FoundKey)
        Fluent:Notify({Title = "æˆåŠŸ", Content = "å¡å¯†å·²ä¿å­˜ï¼Œä¸‹æ¬¡è‡ªåŠ¨ç”Ÿæ•ˆ", Duration = 3})
    end
end

function RayfieldKeySystem:OnKeyInvalid()
    self.AttemptsRemaining = self.AttemptsRemaining - 1
    self.KeyMain.Input.InputBox.Text = ""
    -- é”™è¯¯æŠ–åŠ¨åŠ¨ç”»
    TweenService:Create(self.KeyMain, TweenInfo.new(0.2), {Position = UDim2.new(0.495, 0, 0.5, 0)}):Play()
    task.wait(0.1)
    TweenService:Create(self.KeyMain, TweenInfo.new(0.2), {Position = UDim2.new(0.505, 0, 0.5, 0)}):Play()
    task.wait(0.1)
    TweenService:Create(self.KeyMain, TweenInfo.new(0.2), {Position = UDim2.new(0.5, 0, 0.5, 0)}):Play()
    if self.AttemptsRemaining <= 0 then
        self:CloseKeyUI()
        LocalPlayer:Kick("å¡å¯†é”™è¯¯æ¬¡æ•°è¿‡å¤š")
    end
end

function RayfieldKeySystem:CloseKeyUI()
    if self.KeyUI then
        TweenService:Create(self.KeyMain, TweenInfo.new(0.6), {BackgroundTransparency = 1}):Play()
        task.wait(0.5)
        self.KeyUI:Destroy()
    end
end

function RayfieldKeySystem:WaitForValidation()
    if self.Passthrough then
        Fluent:Notify({Title = "éªŒè¯æˆåŠŸ", Content = "æ­£åœ¨åŠ è½½è„šæœ¬...", Duration = 3})
        return true
    end
    self:LoadKeyUI()
    repeat task.wait() until self.Passthrough
    return true
end

-- ==================== æ€§èƒ½ç®¡ç†å™¨ï¼ˆDelta å†…å­˜ä¼˜åŒ–ï¼‰====================
local PerformanceManager = {
    Connections = {},
    ESPInstances = {},
    LastScanTime = 0,
    ScanInterval = 0.5
}

function PerformanceManager:RegisterConnection(conn)
    table.insert(self.Connections, conn)
end

function PerformanceManager:Cleanup()
    for _, conn in ipairs(self.Connections) do
        if conn and conn.Connected then conn:Disconnect() end
    end
    self.Connections = {}
    for _, esp in ipairs(self.ESPInstances) do
        if esp and esp.Parent then esp:Destroy() end
    end
    self.ESPInstances = {}
end

function PerformanceManager:CanScan()
    local now = tick()
    if now - self.LastScanTime >= self.ScanInterval then
        self.LastScanTime = now
        return true
    end
    return false
end

-- ==================== Fluent UI çª—å£åˆ›å»ºï¼ˆDelta é€‚é…ï¼‰====================
local Window = Fluent:CreateWindow({
    Title = "BSé»‘æ´ä¸­å¿ƒ | Delta é€‚é…ç‰ˆ",
    SubTitle = "ä½œè€…QQ: 1545959422",
    TabWidth = 180,
    Size = UDim2.fromOffset(650, 550),
    Acrylic = true,
    Theme = GlobalState.CurrentTheme,
    MinimizeKey = Enum.KeyCode.F5, -- Delta å¸¸ç”¨å¿«æ·é”®
    Parent = gethui() or CoreGui -- Delta å®‰å…¨æŒ‚è½½
})

-- å®šä¹‰æ‰€æœ‰æ ‡ç­¾é¡µï¼ˆå¯¹åº”åŸè„šæœ¬åŠŸèƒ½ï¼‰
local Tabs = {
    Main = Window:AddTab({Title = "ä¸»ç•Œé¢", Icon = "home"}),
    Horror = Window:AddTab({Title = "æé¬¼ç—‡", Icon = "ghost"}),
    Forest99 = Window:AddTab({Title = "æ£®æ—99å¤œ", Icon = "tree"}),
    Doors = Window:AddTab({Title = "Doors", Icon = "door"}),
    InkGame = Window:AddTab({Title = "å¢¨æ°´æ¸¸æˆ", Icon = "droplet"}),
    DeadRail = Window:AddTab({Title = "æ­»é“è½¨", Icon = "train"}),
    SlapSim = Window:AddTab({Title = "å·´æŒæ¨¡æ‹Ÿå™¨", Icon = "hand"}),
    Ninja = Window:AddTab({Title = "å¿è€…ä¼ å¥‡", Icon = "ninja"}),
    Strength = Window:AddTab({Title = "åŠ›é‡ä¼ å¥‡", Icon = "dumbbell"}),
    Settings = Window:AddTab({Title = "è®¾ç½®", Icon = "settings"})
}

-- ==================== ä¸»ç•Œé¢æ ‡ç­¾é¡µ ====================
do
    Tabs.Main:AddParagraph({
        Title = "ğŸ¯ BSè„šæœ¬ Delta é€‚é…ç‰ˆ",
        Content = "æ”¯æŒå¤šæ¸¸æˆåŠŸèƒ½ï¼ŒF5 éšè—/æ˜¾ç¤ºç•Œé¢\næ‰€æœ‰åŠŸèƒ½å·²é€‚é… Delta æ³¨å…¥å™¨ï¼Œç¨³å®šè¿è¡Œ"
    })
    Tabs.Main:AddButton({
        Title = "å¤åˆ¶ä½œè€…QQ",
        Description = "ç‚¹å‡»å¤åˆ¶è”ç³»QQ: 1545959422",
        Callback = function()
            setclipboard("1545959422")
            Fluent:Notify({Title = "æˆåŠŸ", Content = "QQå·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", Duration = 2})
        end
    })
    Tabs.Main:AddToggle({
        Title = "å¯ç”¨æ–‡ä»¶ä¿å­˜",
        Description = "ä¿å­˜ SkidSpy æ—¥å¿—åˆ°æœ¬åœ°",
        Default = GlobalState.Config.FileSaving,
        Callback = function(state)
            GlobalState.Config.FileSaving = state
            if state and not isfolder("Skid-Spy") then
                makefolder("Skid-Spy")
            end
        end
    })
end

-- ==================== æé¬¼ç—‡æ ‡ç­¾é¡µ ====================
do
    local EMFCount = 0
    local GhostLock = true
    local Cursed = {}

    -- åˆå§‹åŒ–æ£€æµ‹
    local function initHorrorFeatures()
        local WorkspaceDescendants = Workspace:GetDescendants()
        for _, obj in ipairs(WorkspaceDescendants) do
            if obj:IsA("Model") and (obj.Name == "Ouija Board" or obj.Name == "SummoningCircle") then
                Cursed = obj
            elseif obj:IsA("Tool") and obj.Name == "Tarot Cards" then
                Cursed = obj
            end
        end
    end
    initHorrorFeatures()

    -- æ§ä»¶åˆ›å»º
    Tabs.Horror:AddParagraph({Title = "EMFè®¡æ•°å™¨", Content = "å½“å‰æ£€æµ‹åˆ° " .. EMFCount .. " æ¬¡äº’åŠ¨"})
    Tabs.Horror:AddButton({
        Title = "å¤œè§†æ¨¡å¼",
        Callback = function()
            local Lighting = getService("Lighting")
            Lighting.Brightness = 2
            Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
            Lighting.GlobalShadows = false
            Fluent:Notify({Title = "å¯ç”¨", Content = "å¤œè§†æ¨¡å¼å·²å¼€å¯", Duration = 2})
        end
    })
    Tabs.Horror:AddToggle({
        Title = "å¹½çµé€è§†",
        Default = GlobalState.Features.ChildESP,
        Callback = function(enabled)
            GlobalState.Features.ChildESP = enabled
            GhostLock = not enabled
            if enabled then
                coroutine.wrap(function()
                    while not GhostLock do
                        for _, ghost in ipairs(Workspace:GetChildren()) do
                            if ghost.Name == "Ghost" and ghost:IsA("Model") then
                                for _, part in ipairs(ghost:GetChildren()) do
                                    if part:IsA("MeshPart") and not part:FindFirstChild("GhostESP") then
                                        local adornment = Instance.new("BoxHandleAdornment")
                                        adornment.Name = "GhostESP"
                                        adornment.Size = Vector3.new(1, 1, 1)
                                        adornment.AlwaysOnTop = true
                                        adornment.Transparency = 0.4
                                        adornment.Adornee = part
                                        adornment.Parent = part
                                        table.insert(PerformanceManager.ESPInstances, adornment)
                                    end
                                end
                            end
                        end
                        task.wait(1)
                    end
                end)()
            end
        end
    })
end

-- ==================== Forest99 æ ‡ç­¾é¡µ ====================
do
    -- ç‰©å“é…ç½®ï¼ˆä¿ç•™åŸå®šä¹‰ï¼‰
    local itemConfig = {{name = "Log", display = "æœ¨å¤´", espColor = Color3.fromRGB(139, 69, 19)},
        {name = "Carrot", display = "èƒ¡èåœ", espColor = Color3.fromRGB(255, 165, 0)},
        {name = "Chest", display = "å®ç®±", espColor = Color3.fromRGB(210, 180, 140)}}

    -- æ€æˆ®å…‰ç¯å¼€å…³
    Tabs.Forest99:AddToggle({
        Title = "æ€æˆ®å…‰ç¯",
        Description = "è‡ªåŠ¨æ”»å‡»100ç±³å†…æ•Œäºº",
        Default = GlobalState.Features.KillAura,
        Callback = function(state)
            GlobalState.Features.KillAura = state
        end
    })

    -- è‡ªåŠ¨ç æ ‘å¼€å…³
    Tabs.Forest99:AddToggle({
        Title = "è‡ªåŠ¨ç æ ‘",
        Description = "è‡ªåŠ¨ç ä¼é™„è¿‘æ ‘æœ¨",
        Default = GlobalState.Features.AutoChop,
        Callback = function(state)
            GlobalState.Features.AutoChop = state
        end
    })

    -- ç‰©å“é€è§†æŒ‰é’®
    for _, item in ipairs(itemConfig) do
        Tabs.Forest99:AddButton({
            Title = item.display .. "é€è§†",
            Callback = function()
                local items = {}
                local folders = {"Items", "MapItems", "WorldItems"}
                for _, folderName in ipairs(folders) do
                    local folder = Workspace:FindFirstChild(folderName)
                    if folder then
                        for _, obj in ipairs(folder:GetDescendants()) do
                            if obj.Name == item.name and obj:IsA("Model") then
                                local part = obj.PrimaryPart or obj:FindFirstChild("Handle")
                                if part and not part:FindFirstChild("ESP") then
                                    local billboard = Instance.new("BillboardGui")
                                    billboard.Name = "ESP"
                                    billboard.Adornee = part
                                    billboard.Size = UDim2.new(0, 100, 0, 30)
                                    billboard.AlwaysOnTop = true
                                    local text = Instance.new("TextLabel")
                                    text.Text = item.display
                                    text.Size = UDim2.new(1, 0, 1, 0)
                                    text.TextColor3 = item.espColor
                                    text.BackgroundTransparency = 1
                                    text.Parent = billboard
                                    billboard.Parent = part
                                    table.insert(PerformanceManager.ESPInstances, billboard)
                                end
                            end
                        end
                    end
                end
                Fluent:Notify({Title = "å¯ç”¨", Content = item.display .. "é€è§†å·²å¼€å¯", Duration = 2})
            end
        })
    end

    -- ä¼ é€ç¯ç«æŒ‰é’®
    Tabs.Forest99:AddButton({
        Title = "ä¼ é€å›ç¯ç«",
        Callback = function()
            local Character = LocalPlayer.Character
            if not Character or not Character:FindFirstChild("HumanoidRootPart") then
                Fluent:Notify({Title = "é”™è¯¯", Content = "è§’è‰²æœªå‡†å¤‡å¥½", Duration = 2})
                return
            end
            Character:MoveTo(Vector3.new(0.189, 7.831, -0.341))
            Fluent:Notify({Title = "æˆåŠŸ", Content = "å·²ä¼ é€å›ç¯ç«", Duration = 2})
        end
    })
end

-- ==================== Doors æ ‡ç­¾é¡µ ====================
do
    -- Doors ç‰©å“é…ç½®
    local DoorsItemConfig = {{name = "Door", display = "é—¨", espColor = Color3.fromRGB(255, 255, 255)},
        {name = "KeyObtain", display = "é’¥åŒ™", espColor = Color3.fromRGB(255, 215, 0)},
        {name = "Wardrobe", display = "æŸœå­", espColor = Color3.fromRGB(139, 69, 19)}}

    -- ç¬é—´äº’åŠ¨
    Tabs.Doors:AddToggle({
        Title = "ç¬é—´äº’åŠ¨",
        Default = GlobalState.DoorsInstantInteract,
        Callback = function(state)
            GlobalState.DoorsInstantInteract = state
            if state then
                ProximityPromptService.PromptButtonHoldBegan:Connect(function(prompt)
                    prompt.HoldDuration = 0
                    fireproximityprompt(prompt)
                end)
            end
        end
    })

    -- è¿ç»­è¿‡é—¨
    Tabs.Doors:AddToggle({
        Title = "è‡ªåŠ¨è¿‡é—¨",
        Default = GlobalState.DoorsAutoSkip,
        Callback = function(state)
            GlobalState.DoorsAutoSkip = state
            if state then
                task.spawn(function()
                    while state do
                        pcall(function()
                            local LatestRoom = ReplicatedStorage.GameData.LatestRoom.Value
                            local CurrentDoor = Workspace.CurrentRooms[tostring(LatestRoom)]:WaitForChild("Door")
                            LocalPlayer.Character:PivotTo(CFrame.new(CurrentDoor.Door.Position))
                            task.wait(0.3)
                            CurrentDoor.ClientOpen:FireServer()
                        end)
                        task.wait(0.5)
                    end
                end)
            end
        end
    })

    -- ç‰©å“é€è§†å¼€å…³
    for _, item in ipairs(DoorsItemConfig) do
        Tabs.Doors:AddToggle({
            Title = item.display .. "é€è§†",
            Default = false,
            Callback = function(enabled)
                item.enabled = enabled
                if enabled then
                    for _, obj in ipairs(Workspace:GetDescendants()) do
                        if obj.Name == item.name and obj:IsA("Model") then
                            local highlight = Instance.new("Highlight")
                            highlight.FillColor = item.espColor
                            highlight.OutlineColor = item.espColor
                            highlight.FillTransparency = 0.3
                            highlight.Parent = obj
                            table.insert(PerformanceManager.ESPInstances, highlight)
                        end
                    end
                end
            end
        })
    end
end

-- ==================== è®¾ç½®æ ‡ç­¾é¡µ ====================
do
    Tabs.Settings:AddDropdown({
        Title = "ç•Œé¢ä¸»é¢˜",
        Values = Fluent.Themes,
        Default = GlobalState.CurrentTheme,
        Callback = function(theme)
            GlobalState.CurrentTheme = theme
            Fluent:SetTheme(theme)
            SaveManager:SaveConfig()
        end
    })

    Tabs.Settings:AddToggle({
        Title = "æ¯›ç»ç’ƒæ•ˆæœ",
        Default = true,
        Callback = function(state)
            Fluent:ToggleAcrylic(state)
        end
    })

    Tabs.Settings:AddButton({
        Title = "æ¸…ç†å†…å­˜",
        Description = "é‡Šæ”¾ESPå’Œè¿æ¥å ç”¨çš„å†…å­˜",
        Callback = function()
            PerformanceManager:Cleanup()
            Fluent:Notify({Title = "æˆåŠŸ", Content = "å†…å­˜å·²æ¸…ç†", Duration = 2})
        end
    })

    -- é…ç½®ä¿å­˜
    SaveManager:SetLibrary(Fluent)
    InterfaceManager:SetLibrary(Fluent)
    SaveManager:SetFolder("BS_Script/Delta")
    SaveManager:LoadAutoloadConfig()
end

-- ==================== æ ¸å¿ƒåŠŸèƒ½å¾ªç¯ï¼ˆDelta æ€§èƒ½ä¼˜åŒ–ï¼‰====================
local mainLoop = RunService.Heartbeat:Connect(function()
    if not PerformanceManager:CanScan() then return end
    local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    if not Character:FindFirstChild("HumanoidRootPart") then return end

    -- è‡ªåŠ¨æ€æˆ®
    if GlobalState.Features.KillAura then
        if Character:FindFirstChild("ToolHandle") then
            local tool = Character.ToolHandle.OriginalItem.Value
            if tool and ({["Old Axe"] = true, ["Spear"] = true})[tool.Name] then
                for _, target in ipairs(Workspace.Characters:GetChildren()) do
                    local distance = (Character.HumanoidRootPart.Position - target.HumanoidRootPart.Position).Magnitude
                    if distance <= 100 then
                        ReplicatedStorage.RemoteEvents.ToolDamageObject:InvokeServer(target, tool, true)
                    end
                end
            end
        end
    end

    -- è‡ªåŠ¨ç æ ‘
    if GlobalState.Features.AutoChop then
        if Character:FindFirstChild("ToolHandle") then
            local tool = Character.ToolHandle.OriginalItem.Value
            if tool and ({["Old Axe"] = true, ["Iron Axe"] = true})[tool.Name] then
                for _, tree in ipairs(Workspace.Map.Foliage:GetChildren()) do
                    if tree:IsA("Model") and tree:FindFirstChild("Trunk") then
                        local distance = (Character.HumanoidRootPart.Position - tree.Trunk.Position).Magnitude
                        if distance <= 100 then
                            ReplicatedStorage.RemoteEvents.ToolDamageObject:InvokeServer(tree, tool, true)
                        end
                    end
                end
            end
        end
    end
end)
PerformanceManager:RegisterConnection(mainLoop)

-- ==================== å¡å¯†éªŒè¯ï¼ˆå¯åŠ¨æ—¶æ‰§è¡Œï¼‰====================
local function LoadScriptAfterValidation()
    -- ç™½åå•æ£€æµ‹ï¼ˆDelta å…¼å®¹ï¼‰
    local isWhitelisted = false
    local success, whitelist = pcall(function()
        return game:HttpGet("https://gitee.com/BS_script/script/raw/master/ç™½åå•")
    end)
    if success then
        for name in whitelist:gmatch("[^\r\n]+") do
            if LocalPlayer.Name:lower() == name:lower() then
                isWhitelisted = true
                break
            end
        end
    end

    if isWhitelisted then
        Fluent:Notify({Title = "ç™½åå•ç”¨æˆ·", Content = "è·³è¿‡å¡å¯†éªŒè¯ï¼ŒåŠ è½½åŠŸèƒ½ä¸­", Duration = 3})
        Window:Show()
        return
    end

    -- å¡å¯†éªŒè¯
    local KeySystem = RayfieldKeySystem.new({
        Title = "BSè„šæœ¬",
        Subtitle = "Delta é€‚é…ç‰ˆå¡å¯†éªŒè¯",
        Note = "QQç¾¤ï¼š467186748 è·å–å¡å¯†",
        FileName = "BS_Script_Delta",
        SaveKey = true,
        Key = {"https://raw.githubusercontent.com/BS58dL/Rayfield-Key-List/refs/heads/main/KeyList.txt"}
    }, false)

    if KeySystem:WaitForValidation() then
        Window:Show()
        Fluent:Notify({Title = "åŠ è½½å®Œæˆ", Content = "æ‰€æœ‰åŠŸèƒ½å·²å°±ç»ªï¼ŒF5 éšè—/æ˜¾ç¤º", Duration = 3})
    end
end

-- Delta æ³¨å…¥å™¨å¯åŠ¨æ—¶æ‰§è¡Œ
task.spawn(LoadScriptAfterValidation)

-- è¿”å› Fluent å¯¹è±¡
return Fluent
